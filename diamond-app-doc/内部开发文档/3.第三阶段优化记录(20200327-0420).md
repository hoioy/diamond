第三阶段主要目标是：完善测试，精简代码
## 重构和优化效果
1. （进行中）在第二次重构基础代码量上，继续优化。

## 指导思想
1. 极简主义的代码
1. 非常优雅
1. 谨记过犹不及，避免"过度封装"。

## 已完成
### 安全更新
1. 增加同一个Ip，每分钟验证码请求次数
1. 增加登录重试次数限制，默认为12小时内只能重试5次
1. 生产环境配置`swagger2.enable=false`,所有资源都会屏蔽输出,swagger在生产环境不暴露
1. TDF Security的JWT Token二次加密

### 架构优化
1. 抽取tdf-common-jpa和tdf-common-mybatis
1. service层接口原子化，为web层接口重构"web层接口原子化“做准备。原子化的好处
    1. 缓存粒度和缓存命中问题彻底解决。缓存更容易管理，缓存边界更加清晰
    1. 事务更容易控制
    1. 解决“出什么样的接口？接口参数是什么？”等等类似的开发时候的疑惑，提供统一标准。
    1. 附带效果：大幅度减少代码量,发现很多代码逻辑都是重复的或者不是最优的，都没必要写。
1. JPA的关联表的复合主键改为增加Id,删除PKDomain，id规则为两个id字符串拼接，增加BaseJoinXX系列
    1. MybaitsPlus对复合主键的支持不友好，无法与JPA代码保持一致
    1. 简化Domain结构,使得可以抽取出BaseJoinXX系列，定义关联表规范
1. Domain和DTO原子化,所有Domain和DTO保持简洁，原因:
    1. 复杂查询不是一个好的实践
    1. 数据库设计增加外键，不是好的设计。代替为使用业务逻辑进行数据校验。
    1. 彻底杜绝JPA的lazy load问题,结合spring cache缓存，更好地提高查询性能
    1. 对于多表关联分页查询，使用JPA的entityManager+JPQL(HQL)的形式。其他方式如使用Specification技术限制过多，实现起来太复杂且不灵活；使用TDFNativeSQLPageUtil拼接原生SQL很难做到多数据库适配。
    1. 更好的实践是：根据不同的业务和UI显示场景，定义新的的DTO或者扩展DTO字段的形式，而不更改Domain。
    1. 统一JPA与mybatis实现
    1. 为rest接口原子化做准备
    1. 可以删除各种xxxMixin类
1. tdf-security不依赖tdf-sys，抽取TDFUserDTO到common中，从而统一TDF平台的用户.与sys拆分更加清晰
1. 前后端分离与不分离概念清晰化，前后端分离与不分离的概念全部在tdf security模块中实现。
sys模块没有前后端是否分离的概念，sys模块专注在业务逻辑，其中tdf-sys-web的不分离版本只控制导航逻辑。sys模块与security模块完全拆分,互不依赖：
    1. 前后端分离概念清晰化。
    1. tdf-sys-web不依赖tdf-security，但是依赖spring security。
    1. 用户只要使用tdf-security就可以快速实现基于JWT的前后端分离。
    1. 重写tdf的验证码校验逻辑，之前写法有bug。修复多用户同时登录验证码失效的bug。之前的验证码校验逻辑为临时逻辑，不支持多线程和高并发。
    1. 为tdf-sys-web层接口原子化做准备
    1. 为不分离版本代码重构做准备(可能不做)
1. tdf-log不依赖tdf-sys   
1. 乐观锁机制重构
    1. 删除BaseDTO中的乐观锁相关代码，token等等，乐观锁在Dao层实现，在service层和controller层感知不到乐观锁
    1. 所有DTO不再需要重写getSerialVersionUID方法
    1. jpa的乐观锁使用jpa自带的 @Version注解
    1. mybatis的乐观锁使用 @Version注解
1. 关联表BaseJoin系列抽取公共方法
    1. BaseJoinId注解
    1. 删除容易的findXXIdByYYId所有代码
    1. 提供公共抽象方法
1. 主表的基础增删改查缓存失效问题解决
1. 使用更优秀的Excel操作库。关于UserDTO中的@Email、@ExcelResources等注解选择其他
    1. 删除common中的excel包，使用hutool替换
    1. 自动生成excel模块，根据模板上传批量上传数据
   
### 代码细节
1. 删除多余的Role和Group关联表
1. JPA分页查询抽取公共类JpaPageUtil并抽取到baseService中，测试跑通整体修改
1. remark字段抽取公共；备注
1. MenuDTO删除不必要的属性index,icon等等多个，与menu domain保持一致
1. 删除QueryAuthorityDTO，以即相关方法
1. mybatis所有service中不必要的maper注入删减
1. 删除common中RedisKey类
1. tdf-common依赖spring-boot-starter-security
1. log模块代码优化,紊乱代码格式优化
1. log模块切入点表达式改为：within(cn.com.taiji.common.api.BaseController+  从而可以定义日志规范。如果默认规则不满足需求，在tdf-log-sample中将提供动态
注入IWebLogsService的方式，实现用户自定义log。
1. sample增加课程表和分数表。演示实现半动态多表关联分页查询。
1. repository中报错的“!=”换成“<>”
1. 配置文件优化：
    1. 删除sysadmin、authorization属性配置
    1. 合并mybatis和jpa配置
    1. 抽离公共配置，tdf只保留dev，应为tdf只作为开发测试使用，不会部署。
1. 统一异常处理重命名为BaseExceptionHandler
1. BaseXXX统一定义系统日志成员变量，子类不用再重复定义，可以直接使用：“protected Log log = LogFactory.getLog(getClass());”;
1. controller层统一使用iBaseService
1. controller和service统一删除log成员变量，因为父类已经有log了
1. Security配置和File路径配置整理删除，增加tdf前缀  
1. 全局删除`@JsonIgnoreProperties({"handler", "hibernateLazyInitializer"})`
1. 全局删除`@NamedQuery(name = "xxx.findAll", query = "SELECT r FROM xxx r")`
1. 初始化sql简化,增加version字段
1. 删除所有service子类的createDomain和createDTO方法，不用再重写。
1. jpa的service层统一使用iBaseRepository
1. (此条记录已经过时，使用更加优雅的方式实现多表关联动态分页）使用JPA的entityManager+JPQL的形式，实现JPA多表关联分页查询工具类抽取。或者使用JPA的Pageable技术，参考：https://blog.csdn.net/qq_36144258/article/details/80298354

### bug修复
1. 数据字典业务逻辑优化，单级数据字典、多级数据字典，数据字典分类，service层代码合并，
1. mybatis版本的DataItem的children和parent是否可以删除
1. jpa增加Repository注解,否则sample项目不是以cn.com.taiji开头会报错
1. swagger的权限配置问题
1. tdf-security过滤器链中findFirstIdsBySecondId，等方法缓存失效问题解决
    1. BaseJoinXXX缓存的生命周期问题修复
    1. 每次接口调用直接走redis
1. 参数管理添加条件没有搜索, 如果有过滤条件,新增完成之后,应该重置过滤条件并查询,编辑功能页面没数据 ,删除功能应该传id
    
### docs
1. 增加各种IDEs安装lombok的文档
