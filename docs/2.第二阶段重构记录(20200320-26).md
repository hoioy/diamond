第二阶段主要目标是：在第一阶段架构重构的基础上，完成了JPA和Mybatis整合和架构优化
## 重构和优化效果
在第一阶段架构重构的基础上，完成了JPA和Mybatis整合和架构优化。第一和二阶段是主要是重构，为了提高效率顺便优化下代码，最困难的阶段已经过去了。
第二阶段完成的小项有100多项，整体看java代码行数缩减为原来的35%。重构后在很多方面都有效果，如：
1. 目前所有的重构都是包括web层在内以下层的重构，没有改动Rest接口，所以前端不需要做任何改动。
1. 面向接口编程，让模块间关系更加合理，模块拆分更加合理，使得tdf-bom、diamond-common、diamond-log、diamond-security都可以独立使用，按模块自由组合使用。
1. 抽取BaseXXX系列，从而规范化公共逻辑如domain与DTO转换逻辑、基本crud等等重复性逻辑。并实现代码级别的约束和强制性规范，而不是口头规范。从而提高开发效率、提高代码稳定性和健壮性。
1. 基本做到对事务、缓存、JPA、Mybatis、Swagger等等技术体系的整体把控，修复因技术盲点导致的技术滥用、架构不合理和一些潜在bug。
1. JPA做了大量优化和精简。
1. Mybatis在精简的基础上实现了全功能覆盖,并且从架构设计上强制jpa和mybatis代码同步维护。

总之，对tdf-base使用者来说，即使不使用代码生成器，后端也可以做到5分钟完成一个功能完善的基础主子表业务逻辑。
如果结合我们融入到tdf-sample-jwt里面的代码生成器，后端基本上做到几秒中完成一套功能完善的主子表业务逻辑。
更重要的是，对于业务的个性化代码。因为有代码级别约束的存在，一方面使得写个性化业务代码很高效，另一方面这些代码级约束可以减少个性化代码的bug。

* 第三阶段不是重构，是全方位代码精简和优化，第三阶段优化将要对Rest接口进行优化，所以会改一些前端代码。
* 第三阶段可以和项目同时进行。
* 预计第三阶段重构后框架后端代码行数会在10000行左右。代码量少意味着，bug少、好维护、节约成本.....。

### 代码统计对比
* 重构后pom配置量为原来的1/3，mybatis的xml做大幅度精简，properties配置没有变（没有优化）,前端不变等等其他情况不考虑。
* 截至到2020年3月26日的`.java`代码统计如下：

> 重构后：

|工程|总行数|有效行数|  
|------|-----|---|
|diamond-base-platform|14195|9052|
> 重构前：

|工程|总行数|有效行数|   
|------| -----|----|
| 总计  | 39577      |   24419    |  
| Diamond-bom  | 0     |   0    |    
| Diamond-common  | 2691     |   1664    |    
| Diamond-util   | 1327     |   861  |  
| Diamond-log       | 1775      |   1089    |   
| Diamond-security  | 2238      |   1483    |  
| Diamond-sys        | 11917      |   7398    |  
| Diamond-sys-mybatis | 11923     |   6730    |  
| Diamond-sys-web（包含不分离版本代码）   | 4945      |   3164    |  
| Diamond-sample-jwt   | 1906      |   1235    |  
| Diamond-sample-jwt-mybatis  | 855      |   495    |  

## 指导思想
1. 极简主义的代码
1. 谨记过犹不及，避免"过度封装"。

## 已完成
### 全局
1. searchRestDto属性名统一更改为pageDTO
1. diamond-sys-jpa(mybatis)也依赖tdf-log，后续补全service层和dao层的业务日志
1. diamond-log和tdf-security拆分清晰，测试日志的basedomain的LastModifiedDate等注解是否好使
1. 统一删除salt参数、属性和相关配置，统一使用 serialVersionUID 代替salt
1. 缓存支持过期时间支持动态配置，增加timeToLive属性。
1. 剥离tdf-sys和tdf-sys-jpa，面向接口编程
1. 所有service接口以I开头。
1. 所有service接口的入参和出参都应该是DTO，不能存在Domain
1. 所有service实现都以impl结尾
1. 依赖hutool
1. 统一修改包名。统一按照“分层/业务模块”这种逻辑来统一包名。
1. 关于删除逻辑的统一：所有关联表使用物理删除，所有主表使用逻辑删除。
1. 把混乱的接口命名统一化，同样类型的接口使用同样模式的命名，比如findXXByXXId统一使用这种模式，而不是胡乱起名。
1. 抽取TDFStatic，防止框架自定义变量如 ROLE_ID_KEY
1. domain名称dto名称和表名不匹配，导致自动生成代码不匹配问题统一修改。如User-》UserInfo
1. parentId抽取为公共属性，可为空，抽取公共的list转tree方法。
1. Mybatis版本，因为Mybatis版本代码还停留在2.1.5版本，不是最新的，需要与JPA最先代码对比，所以先移植JPA版本。
1. 所有模块的pom依赖清理
1. 应该将根据ID删除，批量删除等等接口命名进行规范，如batchDelete，不能随意命名。
1. DTO与Domain对象转化代码应该抽取公共

### diamond-sys-web
1. diamond-sys-web只需要依赖tdf-sys，不因该依赖具体的实现类tdf-sys-jpa和tdf-sys-mybatis
1. diamond-sys-web应该只面向DTO和service接口，不应该依赖Domain和Impl。
1. 删除所有repository，修改为相应的service。web层只面向service层。web层不能直接调用
1. 所有RestController改为Controller后缀
1. 继承BaseController

### diamond-sys-jpa
1. AuthorityServiceImpl是service不应该使用@RestController注解
1. repository统一继承自IBaseRepository
1. properties包移重构,FilePathProperties重构，移动到tdf-common,作为公共配置
1. DelFlagConstant整理,删除
1. 统一删减重复方法，规范化接口
1. 统一依赖接口，而不是实现类Impl
1. 统一抽取DTO与Domain互转方法，userGroupServiceImpl、RoleServiceImpl、ParameterServiceImpl类似代码删除
1. 统一新增、更新、批量新增、批量更新方法
1. 统一规范private修饰符，缺少的补上
1. 删除无用的：ParameterId类.Parameter增加唯一约束
1. 所有repository类注解优化:
    1. 统一使用@Where(clause = "flag=1")注解，去掉@Query，简化
    1. RoleMenuKeyPK 与 RoleMenuPK 重复，只保留 RoleMenuPK
    1. 统一删除updateFlag方法
1. IAuthorityService 和 AuthorityServiceImpl 删除
1. 所有关联表repository的对外接口统一化，统一提供findXXIdsByYYIds。
1. 抽取TDFJpaPageUtil静态变量
1. roleName唯一索引
1. 统一增加@Override，将错误的public和private问题暴露出来
1. 统一分页逻辑的Map改为PageDTO，如RoleService
1. 统一使用唯一约束，替换增删改查中的java代码重复约束，如dept_name不可重复的约束逻辑
1. repository多余方法再次清理,如：UserGroupRepository、ParameterInfoRepository等
1. Menu 删除parent和child，改为使用parentId的方式,进行逻辑简化
1. DataItem 删除parent和child，改为使用parentId的方式,进行逻辑简化
1. Dept 删除parent和child，改为使用parentId的方式,进行逻辑简化, 精简mybatis版本代码
1. BeanToMap移动到common，删除

### diamond-security
1. diamond-security 只需要依赖tdf-sys，面向接口编程
1. diamond-security 应该只面向DTO和service接口，不应该依赖Domain和Impl。
1. 只依赖tdf-common，不依赖tdf-sys，使得tdf-security可以作为独立模块，被其他spring boot应用依赖。
1. 删除TaijiUsernamePasswordAuthenticationFilter，不使用这种方式。

### diamond-common
1. 增加DeptUserPKDTO、UserGroupUserPKDTO、RoleMenuPKDTO、RoleUserPKDTO
1. 删除UserDTORest, UserDTORest和UserDTO合并
1. 只保留TDFBeanUtil。删除其他Bean相关Util。
1. DTO基础属性移动到BaseDTO

### diamond-log
1. 所有业务代码优化，重写，删除不分离版本代码
1. LogOperationType代码优化
1. WebSiteUtil抽取到tdf-common
1. diamond-log、diamond-log-jpa和tdf-log-mybatis合并为tdf-log、
1. diamond-log使用JDBC重新实现 ，diamond-log使用jdbc，不使用jpa或者mybatis，原因：
    1. 目前看tdf-log代码简单，不需要维护tdf-log-jpa和tdf-log-mybatis多个模块
    1. 以后tdf-log主键复杂的时候，作为基础模块要求高性能，jdbc可以写得性能高
    1. 如果依赖 BaseServiceImpl，那么需要依赖tdf-sys-jpa或者tdf-sys-mybatis，不合理，没有了独立性。如果抽取BaseServiceImpl到更上级，则模块拆分有些复杂.
    1. 自动建表问题解决：jdbc自动建表
    1. 多数据源问题解决：针对不同数据库适配

### diamond-sys-mybatis
1. 重写mybatis版本代码
1. 统一service+impl的形式