## 一、主题介绍

### vue+elementui项目主题动态换肤实现

动态换肤基本上是一个前端的基本需求，TDF 产品之前没有这个功能，现对齐进行补充，vue+element-ui 实现了动态主题修改，主要使用element-ui官方推荐的自定义主题方法实现自定义主题。然后用到gulp-css-wrap工具实现 不同的css文件里的每个元素外面包裹一个独特的class名字，方便做主题的动态切换。封装了动态切换主题的Theme组件，对于TDF项目中自定义组件做了特殊处理。详细请参考太极开发者社区博客

https://tech.taiji.com.cn/#/blog/view/8067b72f2721441087179a46e4243c86  最终可实现主题的动态全局切换，对现有主题不满意也可按照文档自定义配置组件颜色。

动态换肤基本上是一个前端的基本需求，TDF 产品之前没有这个功能，现对齐进行补充，记录实现过程如下：

下面所有操作以现有的最新版TDF为基础，已搭建好项目环境

### 1、vue实现主题自定义

#### 1.1 安装主题工具

根据ElementUI官网的自定义主题（http://element.eleme.io/#/zh-CN/component/custom-theme）来安装【主题生成工具】。

首先安装【主题生成工具】，可以全局安装或者安装再当前项目目录下，推荐安装在项目里，方便别人clone项目时能直接安装依赖启动，这里使用全局安装做演示。

```
npm i element-theme -g
```

#### 1.2 然后安装chalk主题

```
npm i element-theme-chalk -D
```

或从github

```
npm i https://github.com/ElementUI/theme-chark -D
```

#### 1.3 初始化变量文件

控制台输

```
et -i  [可以自定义变量文件，默认为element-variables.scss]
```

终端显示

```
 ✔ Generator variables file
```

这时根目录下会产生element-variables.scss（或自定义的文件），内容大致如下：

![](./image/1.png)

#### 1.4 修改变量

直接编辑 element-variables.scss 文件，例如修改主题色为自己所需要的颜色（如：#A68064）

```
$--color-primary: #A68064 !default ;
```

#### 1.5 编译主题

在控制台执行

```
et
```

编译主题 显示

![](./image/2.png)编译完之后会在根目录生成theme的文件夹
![](./image/4.png)

执行主题编译命令生成主题，根目录会生成一个theme的文件夹 。需要引入这个文件夹里的css、font等资源。theme文件夹里有font文件夹和大量的css文件，css文件只留下index.css,其他的css文件都可以删掉，因为index.css中的样式包含其他全部css文件的样式。 删除其他css后

![](./image/3.png)


#### 1.6 引入自定义的主题

最后一步，将编译好的主题文件引入项目（编译的文件默认在根目录下的theme文件下，也可以通过 -o 参数指定打包目录），在入口文件main.js中引入

```
import Element from 'element-ui'
import '@/styles/index.scss'
import '../theme/index.css'
```

#### 1.7 写一组button测试是否改变成功

 **<div>**
      <el-button>默认按钮</el-button>
      <el-button type="primary">主要按钮</el-button>
      <el-button type="success">成功按钮</el-button>
      <el-button type="info">信息按钮</el-button>
      <el-button type="warning">警告按钮</el-button>
      <el-button type="danger">危险按钮</el-button>
  **</div>**

显示如图

![](./image/5.png)

### 2、gulp-css-wrap工具的使用

不同的css文件里的每个元素外面包裹一个独特的class名字，可使用gulp-css-wrap工具打包

#### 2.1 gulp环境搭建

```
//1.安装gulp：
npm install  gulp

//2.安装gulp-clean-css
npm install gulp-clean-css --save-dev

//3.安装gulp-css-wrap
npm install gulp-css-wrap
```

#### 2.2 在项目根目录下创建一个名为 gulpfile.js 的文件

```
// gulpfile.js
var path = require('path')
var gulp = require('gulp')
var cleanCSS = require('gulp-clean-css')
var cssWrap = require('gulp-css-wrap')
gulp.task('css-wrap', function() {
  return gulp.src(path.resolve('./theme/index.css'))
    /* 找需要添加命名空间的css文件，支持正则表达式 */
    .pipe(cssWrap({
      selector: '.custom-3C9AFB' /* 添加的命名空间 */
    }))
    .pipe(cleanCSS())
    .pipe(gulp.dest('src/assets/css/theme/3C9AFB')) /* 存放的目录 */
})
```

#### 2.3 执行gulp输出

```
//命令行
gulp css-wrap
```

![](./image/6.png)

可看到在src/css/theme 下面生成对应名称的css文件 和上面2.2 gulpfile.js 的文件规定相关的

![](./image/8.png)

![](./image/7.png)

###  3、封装动态换肤色Theme.vue组件

![](./image/9.png)

动态切换主题的原理，首先我们用vuex用来存储当前颜色值，修改或者取值都可通过vuex管理。

#### 3.1 vuex全局管理当前颜色值

vuex 核心代码

```
const store = new Vuex.Store({
  state: {
    themecolor: '3C9AFB'// 默认为3C9AFB
  },
  mutations: {
    // 更新主题颜色
    setThemeColor(state, curcolor) {
      this.state.themecolor = curcolor
    }
  },
```

#### 3.2 封装自动切换主题组件

```
<template>
  <div class="app-container">
    <el-card class="box-card">
      <div slot="header">
        <span style="line-height: 20px;">偏好设置</span>
      </div>
      <div class="mulColor">
        <el-radio-group v-model="themecolor"> // 用户点击颜色值绑定vuex中当前颜色值
          <el-radio label="3C9AFB">
            默认-3C9AFB
          </el-radio>
          <el-radio label="FA4F52">
            橙色-FA4F52
          </el-radio>
          <el-radio label="20a0ff">
            浅蓝色-20a0ff
          </el-radio>
          <el-radio label="008000">
            草绿-008000
          </el-radio>
          <el-radio label="5959AB">
            紫色-5959AB
          </el-radio>
        </el-radio-group>
      </div>
    </el-card>
    <div class="block">
      <span class="demonstration">Button: </span>
      <span class="wrapper">
        <el-button type="primary">主要按钮</el-button>
        <el-button type="success">成功按钮</el-button>
        <el-button type="warning">警告按钮</el-button>
        <el-button type="danger">危险按钮</el-button>
        <el-button type="info">信息按钮</el-button>
      </span>
    </div>

    <div class="block">
      <el-tag v-for="tag in tags" :key="tag.type" class="tag-item" :type="tag.type">
        {{ tag.name }}
      </el-tag>
    </div>

    <div class="block">
      <el-alert class="alert-item" title="成功提示的文案" type="success"/>
      <el-alert class="alert-item" title="消息提示的文案" type="info"/>
      <el-alert class="alert-item" title="警告提示的文案" type="warning"/>
      <el-alert class="alert-item" title="错误提示的文案" type="error"/>
    </div>
  </div>
</template>

<script>
import { toggleClass2 } from '@/utils/index'
export default {
  data() {
    return {
      tags: [
        { name: '标签一', type: '' },
        { name: '标签二', type: 'gray' },
        { name: '标签三', type: 'primary' },
        { name: '标签四', type: 'success' },
        { name: '标签五', type: 'warning' },
        { name: '标签六', type: 'danger' }
      ]
    }
  },
  computed: {
    themecolor: {
      get() {
        return this.$store.state.themecolor
      },
      set(val) {
        this.$store.commit('setThemeColor', val)
      }
    }
  },
  watch: {  //watch监听颜色值的改变 一旦改变就调用vuex的函数
    themecolor: {
      handler() {
        toggleClass2(document.body, 'custom-' + this.themecolor)
      }
    }
  },
  mounted() { // 刚开始载入页面得时候得主题色是vuex的默认值
    toggleClass2(document.body, 'custom-' + this.themecolor)
  }
}
</script>
<style scoped>
    .app-container{
        float: right;
        width: 100%
    }
    .box-card{
        width: 400px;
        margin: 20px auto;
    }
    .block{
        padding: 30px 24px;
    }
    .alert-item{
        margin-bottom: 10px;
    }
    .tag-item{
        margin-right: 15px;
    }
    .link-title{
        margin-left:35px;
    }
    .mulColor{
        margin-top: 15px;
        padding-bottom:5px;
    }
</style>
```

#### 3.3 vue的主题颜色切换

与生成各个颜色不同的css文件类似，我们对应不同的主题定义不同的css，只不过可以用sass解决。   mixi.scss 定义的五个主题颜色

![](./image/10.png)

common.scss

![](./image/11.png)

2. **在组件使用页面引入common.scss**

![](./image/12.png)

然后组件可直接在页面中引用

![](./image/13.png)



### 四、自定义组件颜色不随theme变化解决方案

完成以上三步觉得一切大功告成了 发现侧边栏和Tagviews的颜色不随theme切换变化，查看代码发现原来这两个组件都是自定义的组件，经过在封装且在组件页面单独进行了样式约定设置，大家都知道，这样的样式设置优先级较高的，不受主题颜色的影响，思考了许久，想到了解决方案，TDF参照的模板项目其实也没解决该问题的https://github.com/PanJiaChen/vue-element-admin  我们在组件样式上动态绑定当前vuex中存的主题值。

关键代码demo

```
<router-link
  v-for="tag in visitedViews"
  ref="tag"
  :key="tag.path"
  :style="isActive(tag)?{   //此处动态绑定 点击tagviews时颜色变化
    'background-color': curThemeColor,
    'color': '#ffffff',
    'border-color': curThemeColor
  }:{ }"
  :to="{ path: tag.path, query: tag.query, fullPath: tag.fullPath }"
  tag="span"
  class="tags-view-item"
  @click.middle.native="closeSelectedTag(tag)"
  @contextmenu.prevent.native="openMenu(tag,$event)"
>
  {{ tag.title }}
  <span class="el-icon-close" @click.prevent.stop="closeSelectedTag(tag)"/>
</router-link>

....
 watch: {
    $route() {
      this.addViewTags()
      this.moveToCurrentTag()
    },
    themecolor: {
      handler() {
        toggleClass2(document.body, 'custom-' + this.themecolor)
        console.log('55555 ' + this.themecolor)
        this.curThemeColor = '#' + this.themecolor.toString()
        console.log('6666  ' + this.curThemeColor)
      }
    },
    ......
    }
```

侧边栏处以及其他点击激活时颜色变化时一样的。

至此，主题动态切换完全实现。

### 五、测试

换肤效果测试

![](./image/14.png)

![](./image/15.png)

参考文章  <https://blog.csdn.net/young_Emily/article/details/78591261>

[基于ElementUI的网站换主题的一些思考与实现](https://www.cnblogs.com/weiqinl/p/7732892.html)

 <https://segmentfault.com/a/1190000009762198#item-3>

<https://www.gulpjs.com.cn/docs/getting-started/quick-start/>
