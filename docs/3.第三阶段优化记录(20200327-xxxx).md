第三阶段主要目标是：完善测试，(包括前端在内)全方位代码级别优化，梳理业务逻辑、接口交互逻辑优化，精简代码
## 重构和优化效果
1. （进行中）在第二次重构基础代码量上，controller层代码再精简最少1/2的代码量。整体工程代码量再精简至少1/3。

## 指导思想
1. 极简主义的代码
1. 非常优雅
1. 谨记过犹不及，避免"过度封装"。

## 已完成
### 架构优化
1. 抽取diamond-common-jpa和diamond-common-mybatis
1. service层接口原子化，为web层接口重构"web层接口原子化“做准备。原子化的好处
    1. 缓存粒度和缓存命中问题彻底解决。缓存更容易管理，缓存边界更加清晰
    1. 事务更容易控制
    1. 解决“出什么样的接口？接口参数是什么？”等等类似的开发时候的疑惑，提供统一标准。
    1. 附带效果：大幅度减少代码量,发现很多代码逻辑都是重复的或者不是最优的，都没必要写。
1. JPA的关联表的复合主键改为增加Id,删除PKDomain，id规则为两个id字符串拼接，增加BaseJoinXX系列
    1. MybaitsPlus对复合主键的支持不友好，无法与JPA代码保持一致
    1. 简化Domain结构,使得可以抽取出BaseJoinXX系列，定义关联表规范
1. Domain和DTO原子化,所有Domain和DTO保持简洁，原因:
    1. 复杂查询不是一个好的实践
    1. 数据库设计增加外键，不是好的设计。代替为使用业务逻辑进行数据校验。
    1. 彻底杜绝JPA的lazy load问题,结合spring cache缓存，更好地提高查询性能
    1. 对于多表关联分页查询，使用JPA的entityManager+JPQL(HQL)的形式。其他方式如使用Specification技术限制过多，实现起来太复杂且不灵活；使用DiamondNativeSQLPageUtil拼接原生SQL很难做到多数据库适配。
    1. 更好的实践是：根据不同的业务和UI显示场景，定义新的的DTO或者扩展DTO字段的形式，而不更改Domain。
    1. 统一JPA与mybatis实现
    1. 为rest接口原子化做准备
    1. 可以删除各种xxxMixin类
1. diamond-security不依赖diamond-sys，抽取DiamondUserDTO到common中，从而统一Diamond平台的用户.与sys拆分更加清晰
1. 前后端分离与不分离概念清晰化，前后端分离与不分离的概念全部在diamond security模块中实现。
sys模块没有前后端是否分离的概念，sys模块专注在业务逻辑，其中diamond-sys-web的不分离版本只控制导航逻辑。sys模块与security模块完全拆分,互不依赖：
    1. 前后端分离概念清晰化。
    1. diamond-sys-web不依赖diamond-security，但是依赖spring security。
    1. 用户只要使用diamond-security就可以快速实现基于JWT的前后端分离。
    1. 重写diamond的验证码校验逻辑，之前写法有bug。修复多用户同时登录验证码失效的bug。之前的验证码校验逻辑为临时逻辑，不支持多线程和高并发。
    1. 为diamond-sys-web层接口原子化做准备
    1. 为不分离版本代码重构做准备(可能不做)
1. diamond-log不依赖diamond-sys   
1. 乐观锁机制重构
    1. 删除BaseDTO中的乐观锁相关代码，token等等，乐观锁在Dao层实现，在service层和controller层感知不到乐观锁
    1. 所有DTO不再需要重写getSerialVersionUID方法
    1. jpa的乐观锁使用jpa自带的 @Version注解
    1. mybatis的乐观锁使用 @Version注解
1. 使用更优秀的Excel操作库。关于UserDTO中的@Email、@ExcelResources等注解选择其他
    1. 删除common中的excel包，使用hutool替换
    1. 自动生成excel模块，根据模板上传批量上传数据
    
### 代码细节
1. 删除多余的Role和Group关联表
1. JPA分页查询抽取公共类JpaPageUtil并抽取到baseService中，测试跑通整体修改
1. remark字段抽取公共；备注
1. MenuDTO删除不必要的属性index,icon等等多个，与menu domain保持一致
1. 删除QueryAuthorityDTO，以即相关方法
1. mybatis所有service中不必要的maper注入删减
1. 删除common中RedisKey类
1. diamond-common依赖spring-boot-starter-security
1. log模块代码优化,紊乱代码格式优化
1. log模块切入点表达式改为：within(BaseController+  从而可以定义日志规范。如果默认规则不满足需求，在diamond-log-sample中将提供动态
注入IWebLogsService的方式，实现用户自定义log。
1. sample增加课程表和分数表。演示实现半动态多表关联分页查询。
1. repository中报错的“!=”换成“<>”
1. 配置文件优化：
    1. 删除sysadmin、authorization属性配置
    1. 合并mybatis和jpa配置
    1. 抽离公共配置，diamond只保留dev，应为diamond只作为开发测试使用，不会部署。
1. 统一异常处理重命名为BaseExceptionHandler
1. BaseXXX统一定义系统日志成员变量，子类不用再重复定义，可以直接使用：“protected Log log = LogFactory.getLog(getClass());”;
1. controller层统一使用iBaseService
1. controller和service统一删除log成员变量，因为父类已经有log了
1. Security配置和File路径配置整理删除，增加diamond前缀  
1. 全局删除`@JsonIgnoreProperties({"handler", "hibernateLazyInitializer"})`
1. 全局删除`@NamedQuery(name = "xxx.findAll", query = "SELECT r FROM xxx r")`
1. 初始化sql简化,增加version字段
1. 删除所有service子类的createDomain和createDTO方法，不用再重写。
1. jpa的service层统一使用iBaseRepository
1. 统一重写DTO上的swagger注解，使得接口描述更加清晰
    1. 接口排序,不同模块使用@Api的tag属性排序，统一模块中的接口@ApiOperationSupport
    1. 
   
### bug修复
1. 数据字典业务逻辑优化，单级数据字典、多级数据字典，数据字典分类，service层代码合并，
1. mybatis版本的DataItem的children和parent是否可以删除
1. jpa增加Repository注解,否则sample项目不是以cn.com.diamond开头会报错
1. swagger的权限配置问题

### 安全更新
1. 增加同一个Ip，每分钟验证码请求次数
1. 增加登录重试次数限制，默认为12小时内只能重试5次
1. 生产环境配置`swagger2.enable=false`,所有资源都会屏蔽输出,swagger在生产环境不暴露
1. Diamond Security的JWT Token二次加密

### docs
1. 增加各种IDEs安装lombok的文档

## 第三阶段优化任务列表（按照重要程度排序）
### 完善集成测试和功能测试
#### 完成集成测试代码，覆盖率要达到100%
#### 重点测试项
1. 统一测试校验 @Transactional , 保证事务生效
1. 统一测试缓存逻辑 @Cacheable , 保证缓存生效，缓存量正确，缓存生命周期正确。检查需要缓存的方法，增加缓存配置
1. 统一测试参数校验逻辑 @Valid , 统一使用Controller层的@Valid 优化精简其他层的校验逻辑

#### 目前发现的bug
1. diamond security的默认白名单机制
1. 数据字典/system/dictionary/query-all query-all方法 使用pageDto接参数,没有传 page pagesize
1. 部门序号校验
1. 部门选中之后点空白地方应该置空
1. PageDTO校验机制，关于dto中的validation注解，如：@Size(min=4, max=20, message="角色名长度只能在4-20之间")
1. 参数管理添加条件没有搜索, 如果有过滤条件,新增完成之后,应该重置过滤条件并查询,编辑功能页面没数据 ,删除功能应该传id
#### 前端和后端web层接口全面优化
1. 所有增删改使用post，put，delete。如目前delete类型接口使用的是get方法，使security的安全防御失效了。
1. 所有接口改为现代化写法。
1. list转tree逻辑移植到前端（后端仍然保留listToTree能力）
1. 删除不必要的接口
1. 。。。。。。很多不一一列举
1. 前后端分离XSS攻击防护
1. 数据权限基础实现方案

#### 架构不合理优化
1. filter层的统一异常
1. diamond log已经抽取了IWebLogService,需要提供一个用户使用diamond log模块的sample，自定义切面使用Log.
1. 统一异常返回code有没有更好的方式
1. 数据权限校验更好的实现方式研究
1. 考虑是否在BaseXX基础上抽取TreeXX，使得逻辑上更合理。或者还是只保留BaseXX，从而保持简洁性。
1. 删除参数管理ParameterInfo相关逻辑，原因如下：
    1. 各种config serve会自动对接动态配置的存储媒介，比如支持存储到git，关系数据库，redis等等。还能各种自动刷新spring boot上下文。功能是完备的。
    1. ParameterInfo逻辑,这种配置不是说用户动态增加一个参数就能拿来用了，用户还得把后端服务器停掉，然后还得改代码硬编码去读取这个参数，再启动后台。
    这本身就没有办法做到动态，功能不完备。
    1. 如果实在有这种需求，dataitem也是key value键值对，直接用data item就行了。
1. @CacheXXX可以加在接口上，但是Sping不建议这么做
1. 增加excel导入用户功能

#### 代码细节优化
1. 使用JPA的entityManager+JPQL的形式，实现JPA多表关联分页查询工具类抽取。或者使用JPA的Pageable技术，参考：https://blog.csdn.net/qq_36144258/article/details/80298354
1. 删除所有queryAll查询类型接口，理论上不支持queryAll查询
1. diamond-common中不应该有@Component类似的注解，防止用户单独依赖diamond-common时候自动注入不必要的对象而引起冲突问题。
1. 精简common模块中的Util类,目标是尽量删除Util，框架自己不维护Util
1. JPA的所有for循环内部调用数据库的全部改为batch类操作
1. jpa的@Param("xxxx") 考虑删除
1. BaseServiceImpl批量逻辑删除的性能问题
1. diamond-security模块拆分清晰后的注入IUserService和IMenuService方式优化。
1. diamond-security代码质量优化(老版本代码代码质量不好)，
1. 使用Optional包装,避免空指针错误。
1. sonarLint工具扫描，彻底解决代码质量问题
1. pom持续精简
1. ParameterInfoDTO属性杂乱需要优化
1. flag改为Boolean类型

#### 新功能
1.  所有配置包名，写死的地方需要改为支持用户动态修改。如log的切面和exception统一异常的切面，将"com.hoioy.diamond"移动到配置文件，支持用户自定义配置
1.  @PreAuthorize("hasAuthority('" + DiamondStatic.ROLE_ID_KEY + "')") 这种接口级权限做成动态可配置的。
1.  支持国际化，优化代码中全部静态字符串，使用静态变量。
1.  使用 Undertow 替换 Tomcat

#### diamond-sample-jwt
1. 考虑diamond-sample-jwt是否有必要拆分为jpa和mybatis两个。
1. 增加单独使用diamond-common、diamond-sys、单独使用diamond-security、单独使用diamond-log的sample示例。
1. config是否抽取，保持diamond入口类的简洁，config设置为默认配置，抽取公共配置，使得外部diamond-sample-jwt和diamond代码量最小，减少copy代码、维护两套相同代码难度。

## 补充
1. 之前佳良做的多数据源
1. 前端等处逻辑bug
#### 第一次汇报大家提出的问题汇总
1. 关于外键和级联、关联主键和复杂主键不是最佳实践的争议
1. 针对parentId，是否有再抽取TreeBaseDomain的必要
1. DiamondJpaQueryWord，是否是最佳实践
1. BaseDomain增加数据库校验,如果service层不做处理，可能不生效的问题
1. 是否使用@ApiOperationSupport(order = 1)代替默认的tag排序
1. StudentDTO的swagger要配置好，作为sample最佳实践示例。
1. 统一异常，不扩展Http状态码。已知的异常和可控的异常，未知的异常使用500。异常分类维度改为技术逻辑，而不是业务。
1. sample中增加普通分页自定义toSpecWithLogicType的示例
1. 所有接口的功能权限控制。

