我不认为我梳理这个文档，是一种低效率和内耗。

工程结构考虑的因素：
1. 团队规模（小团队适合工程结构简单，都在一起），大规模团队适合合理拆分模块减少冲突
1. 是否需要统一的运维脚本等等。
1. 
1. 

既然是思想就有冲突。如果无法接受这种适度的自由、没办法接受这种思想。
那从根儿上就没法开发diamond-base-platform。

规范是双刃剑。
每多一条限制，就意味着别人失去一点"自由"。

我们定义思想、规范等等等，要有度，绝对不能犯“矫枉过正”的错误。比如有人倡导立法：“全国人民不能吃狗肉”。这条
法律就矫枉过正了，道德层面的问题不易上升到法律层面。

做减法，意味着失去自由度，意味着不够包容了。
真诚希望大家能够接受这些思想。统一思想，形成合力，劲儿往一处使，


### 最佳实践
1. 尽量减少service之间互相调用
1. 发生service互相调用时候一定要注意事务传播属性的配置


1. 所有事务配置移动到Service实现类Impl中定义，不要在接口中使用。
1. 删除所有查询方法中的事务配置，查询方法不应该有事务。如果其他有事务的service调用了查询方法导致事务失效，需要考虑调用代码逻辑是否有问题。
1. 事务要增加“rollbackFor = Exception.class”


1. controller层负责参数的校验
 
 
### 对公司的价值
1. 过去我们推广Diamon，技术体系，起码把spring boot+vue。起码统一了技术体系。起码大致的
技术方向我们统一了。部门间技术沟通啊，之类的。
1. 有没有产品，有没有统一的代码风格。直接决定这是不是一个卖人头，拉关系，靠别人吃饭外包公司。
1. 能不能更进一步，推广diamond-common，建立基本的开发标准。
1. sys提供基础的业务逻辑

### 非常简洁
1. 开发时候只需要遵守一定的规范,就非常简单了。
但是我们是框架的开发者，需要了解一些背后的原理
1. 框架的价值，巴拉巴拉，统一思想
1. diamond是如何实现这些价值的。框架设计
四个模块开始。模块间关系。
1. diamond-sample介绍。介绍其中的关键功能点
1. 社区和微服务如何改造。旧版本如何升级。
1. 基于框架的最佳实践

### 结合BaseXX，对所有业务逻辑代码一行一行进行优化
1. 关于BaseXXX的需求梳理  
    1. DTO有公共属性，放在BaseDTO
    1. BaseDTO使得反射和泛型代码更容易写
1. 


### 关于事务在service层的传播
1. 需求；在工位上赵召、赵敏、陈哲、王宏伟一起聊事务后，发现每个人对事务传播的理解都不同，大家对事务的理解有歧义
1. 实际场景分析: 方法A-调用->方法B-调用->方法C （所有方法都在service层)

| 方法A        | 方法B    |  方法C  |   回滚情况  |
| --------   | -----:   | :----: | :----: |
| 无        | 有      |       |      |
| 苹果        | $1      |   6    |   |
| 草莓        | $1      |   7    |     |

同一个类中：
1. 没有事务的方法来调用标注注解@Transactional方法，最后的结论是没有事务
不同类中：
1. 没有事务的方法来调用标注注解@Transactional方法，最后的结论是有事务

在当前含有事务方法内部调用其他的方法(无论该方法是否含有事务)，这就属于Spring事务传播机制的知识点范畴了


对各个部门人们来说，不用也可以，但是只要用了，就会有很多好处，比如：
1. 与公司其他部门其他项目，统一一致的代码风格，使得部门间技术差异化变小，更利于部门间
协作，整体提高公司协同效率。
1. 
1. 
1. 

### 参考
1. http://blog.itpub.net/69900354/viewspace-2565243/

框架的样子：
1. 小而美的框架 vs 大而强的框架
    1. 小而美：机动灵活而专注。美女图。麻雀图，配字：麻雀虽小五脏俱全。对人说，不要瞧不起我。
    1. 大而强：没别的，就是强，学挖掘机找蓝翔。强到不需要别的形容词来夸我，就一个字儿：强。用友的nc产品，属于大而强。
    1. diamond是什么样的框架？（图：外表好看内部杂乱的房子），我只想用一张床，却发现床和墙是一体的。
    举个例子：家里修水管需要把墙壁凿开。
1. diamond要做要给小而美的框架。四个独立且目标清晰的模块：
    1. diamond-common：担心没人管你，没人带你？好办，我就是你爹爹（1949，张国立说的“叫声爹，以后咱就是一家人了”）。“妈妈再也不用担心我没有爸爸了”.
    1. diamond-log：找个代理记账，不用担心偷税漏税了。
    1. diamond-security：不懂安全没关系，给你个锁拿去用吧。
    1. diamond-sys：基础业务：如RBAC,用户管理等等。
   
怎么用？就看您想干啥了。

diamond-common：统一用户。太极各个项目如果用户基础属性是统一的化，那么未来
各种安全集成、统一认证，各个CBB系统集成起来不是更容易吗？为大规模系统集成做好技术储备。
diamond-log：统一日志格式，太极各个项目如果有统一的日志格式，那么使用太极大数据平台时候，
减少很多的不必要的ETL工作量，更利于形成公司化的统一代码风格。
 
每个公司都应该有自己的代码风格，一看代码就知道这是哪个公司的产品。比如：。
那统一代码风格有什么用？很多用处（但是这不是我一个员工应该考虑的问题）。
使用diamond-common以后，其实统一公司代码风格的目的就已经达到了。

领导更多应该协调资源，获取资源,推广产品.

为什么单单针对jpa和mybatis这个orm层维度，抽出独立模块，两套代码？
答：难道还存在别的维度是一套代码搞不定的？


* 完美与海量(大量）任务是矛盾统一的，太完美和不混乱都会导致无法胜任海量任务。我要做的是精简，并且有完美趋向就可以了，把握好度,在某种层度上“柔性可用”就可以了。
* 所谓的可扩展性。可以理解问diamond base的用户，本质上是对diamond base的扩展性开发。而不是
复制过来
* 大而化小，分而治之的道理，从大到系统集成，小到多个类关系梳理，是四海皆准的一个大道理。
所以我们提供service层原子化，rest层原子化，有必要的话，才会在原子化基础上再考虑复杂类型接口。
* 重与轻的关系。黑盒原理也同样是四海皆准的大道理。绝对不是实现几个功能业务逻辑，就敢把一个东西称为框架或者平台，背后的设计思想是非常重的。
    * 设计很重，表现很轻
    * 技术思想很重，实现很轻
    * 后重前轻


为什么要如此纠结框架代码的质量？
1. 项目上，一半情况下会随着项目推进，代码质量逐步下降，直到效率低下，无法忍受阶段会进行重构。这就是所谓的技术债。终归要还的。
1. 框架本身就开始质量塌方了，那怎么可能写出质量好的项目？
1. 小而美的框架，重要的不是美，也不是小，而是包括高效性、稳定性、伸缩性等等这些内在的品质才是最重要的。
 最简单直接的例子：一个不好的框架，会直接导致员工加班严重，bug多导致的头大。普遍是一个程序员做项目挣两个人的钱，那
 能不能一个程序员出去做3个人的钱。这不就是价值么。
 

框架的作用：
1. 答疑解惑：
1. 快速开发：
    1. 提供基础RBAC功能,认证和鉴权功能
    1. 
    1. 规范约束
    1. 不用写重复性逻辑
    1. 



模块拆分：
1. diamond-bom、sys、log、security模块间互相不依赖，可以自由组合使用
1. 每个模块不存在重复性代码的基础上



每个公司都应该有独特的代码风格。
如果做到不到上述这些，那对spring boot二次封装的价值何在？
如果做不到上述这些，那么这还是框架吗？需要打个问号。



### 使用Diamon Base最佳实践
如果使用最佳实践的方式的去写，那么会发现，写起业务代码来又快bug又少。

1. Domain，DTO，service等的建立和自动生成
1. valid
1. 使用统一异常
1. 使用统一Domain和DTO的转换


邱总说：“要东西好，也要宣传好。”
夏总说：“技术创业或者说做成一件事情，首先要把故事讲好，然后才是开发和写代码。”


代码精简以后没几行，讲代码很好讲。但是我想今天大家能耐心下来，别嫌我啰嗦，我想把代码
为什么这么写，背后的思路和思想和大家说说，希望这个思路是走在大道上的，不是歧路，希望
这个思路能够得到领导和同事们的认可。


最后，真正的故事来了：
有一天，有个闺女小赵儿接了一个项目，。。。。。
妈妈我学会了一个谚语叫“磨刀不误砍柴工”，
妈妈再也不用担心我进度慢，bug多了。
10年后，妈妈说：“闺女，你长大了，你可以去演戏了”。


### 领导和同事汇报版本
#### 统一思想，消除误解，团结互助
* 功能不变。java代码减少为原来的xx%。如果包含阉割了不分离版本代码，为原来的。不分离代码，后续考虑融合进来，但是不分离的前端也要重构，现在流水账式充满bug的不分离前端肯定不行。
* 代码少了有什么好处？ 我不知道。大家来告诉我。其实我并不想知道。
* 因为，代码多还是少，并不是我要关注的！一个业务逻辑是10行代码还是100行代码，实现业务逻辑就ok了，代码多还是少只需要慢慢优化就行了，甚至没必要进行优化。有技术债没关系，我的系统稳定运行就好了。
* 作为框架，更应该关注的是“合理性”与“最佳实践”。
* 合理性：是主要价值。 框架本身合理了，就会捎带手地带来：代码简洁（少）、Bug少（稳定）、弹性好（高效）这些附属价值，直接产生快速开发的效果。

* mybatis还是jpa，其实我不care。因为众口难调，也因为我喜欢丰富多彩的世界。我们要做的是，对JPA的优化，对mybatis增强。选择权交给用户，不管用户选择什么，我们提供的都是好的方案。


我们做的是：定义一套统一的开发流程和开发模式或者说是范式，也可以说是统一化、规范化。

大家都知道：
1. 团队合作要遵守统一的代码规范
1. 都知道写代码时候的“约定大于配置”

但是关于“代码规范”这件事，背后的逻辑其实是这样的：
1. 强制性规范，代码级别强制，不符合规范直接报错
1. 非强制性规范（口头式），比如阿里巴巴手册，sonarLint等，甚至“约定大于配置”这种最无助最有无力感的方式，实在没办法了我们才会用“约定大于配置".

* 非强制性规范都是文档和工具。
* 我们框架要解决的问题是，建立强制性规范，增加约束，最简单的方式就是充分利用面向对象特性。

实际做法：
1. 面向对象、面向接口编程方式对框架重构，增加基本的强制性规范，关键是适度。
1. 推荐约定大于配置。减少为了实现对某一逻辑的约束而增加的大量配置性代码，减少出现花费99%的精力，来做1%的功能，这种不划算的开发模式出现。
1. 口头式规范: 一说就看阿里巴巴java开发规范吧，其实这样是不行的。我们仍然要保留自己的规范，比如DTO都以DTO解为。保存方法统一用save这些命名规范。


第一阶段和第二阶段先把架构确定了下来。顺道优化了很多代码。
第三阶段主要是代码优化，进一步更加完美，比如sonarLint。比如：
第四阶段、第五阶段......：不断迭代了




* 所以


优化代码的常用方式（思维导图）
1. 方法业务逻辑的优化
1. 

什么是架构合理：
1. 流水账式代码=不合理=
1. 充分利用面向对象特性：继承、重写、重载=合理
1. 


1. 说这些，都是理论，太空洞，理解全屏想象，需要根据实际代码进行讲解。
1. 



1. 我们的优化绝对不是为了仅仅减少几行代码、而是为了从逻辑架构上的重构。架构越优良，代码会越简洁，减少代码只是优化架构的附带效应。
1. 架构的合理性会到来，开发的快速性。


分两个角度

面向接口编程：抽象编程。
1. 现阶段技术手段：接口、泛型、反射
1. 未来可能会用的技术手段：动态代理

### 用户角度
1. 继承BaseController、BaseService。。。。。。新建个controller都要继承，好烦啊。
    答：这种烦是必要的烦，而且写2个controller后就会习惯。如果我们为了满足用户连继承都不想要。那么我
    们要用更抽象的技术-》动态代理来实现。但是动态代理我个人感觉属于后续要考虑的事情，目前阶段的BaseXXX就能
    快速满足需求了。目前看没必要上动态代理。
1. 
    
### 对外宣传版本


### 重构效果
1. 代码量减少->不仅仅是这些, 更重要的是->这些问题与是JPA还是Mybatis无关。

1. 测试代码覆盖率达到90%，担心重构带来更多的bug。趁机实现单元测试代码
补充上了，并且覆盖率达到90%.有bug吗，有，“有人的地方就有是非，有代码的地方就用bug”

 

框架使用方式：
1. 其他框架展示，如慧点的开发框架、永洪的开发框架。

1. 框架目标。
对spring boot基础上做封装。
    问题：
    1. 中国人就喜欢搞二次封装，中国人怎么不自己搞个框架啊？
    1. 不就是对spring boot做的二次封装么。干嘛重复造轮子？有什么了不起的？
    1. 我直接基于spring boot做好了，干嘛要
    回答：
    1. 中国人的技术不自信，比如huTool做的就别apache common系类好用。我们甚至都会怀疑这个靠谱？

diamond不是一个
1. 从我们开发者自己角度讲
1. 从用户开发角度讲




### 框架的哪些设计可以减少开发时候的bug？

1. 写起代码来不用再小心翼翼
    1. 具体原因


1. 规范化的BaseXXX系列
定义了一套规范，设置基础的逻辑，
自动拼装逻辑删除。

1. 完善的Valid体系
用户不用写一堆if语句来校验入参，只需要在定义DTO时候考虑一次就可以

1. 统一异常。遇到业务异常或者逻辑异常，也同样可以放心的throw，不用再
写try catch逻辑，避免try catch导致的失效bug。

1. 精简的分页查询
1. 

如果这些都没有，那么会导致：
1. 开发业务代码量大，往往代码越多，bug越多。
1. 规范都在口头上，没有代码级别强制约束，导致实际项目没有规范。
1. 最终导致实际开发“全凭个人能力，框架没有帮上忙”的情况出现。



### 代码量为什么会少
1. 


### 拆分后的独立引用逻辑
首要任务，彻底清晰地拆分模块，删除各个模块的错误依赖关系。

其实如果我们的目标是单独作为整体开发框架，让用户基于源代码开发的化，我们没必要拆分成这么多模块。模块多，反而难以维护。开发起来一会儿跳转到那里，一会跳转到这里，反而降低开发效率。
但是我们的目标不仅仅是作为：“源码形式的开发框架”
我们的目标是：
1. 当然支持源码形式的开发(但是不推荐,虽然我支持过的太极的的项目，用户都强烈要求用这种方式)
1. 推荐是用jar包形式使用
1. 并且支持各个模块的单独使用（之前的单独拆分模块逻辑，并没有做到这一点，所以显得一个简单的东西拆成这么多模块，但是又不支持按模块使用，相互矛盾，显得有些鸡肋。
如果无法做到每个模块可以独立使用，那么模块化结构就显得有些生硬，属于“硬拆”，就显得毫无根据、缺少意义。就缺少一个从逻辑上让人说得通的理由），所以我们一定要尽最大可能地支持“各个模块的单独使用”。
    1. 只用diamond-bom的情况，
    1. 只用diamond-common，可以做到，比如diamond-cloud其他模块只需要diamond-common
    1. 只用diamond-security ，其他spring boot应用快速支持动态权限。就要求diamond-security是面向接口的。
    1. 只用diamond-log，


### 框架核心目标
工欲善其事必先利其器、磨刀不误砍柴工。我们要做的就是打造利器,磨好刀。
实现事半功倍。所有的规范都是为了最佳实践这个目标。并不是绝对的，因为有时候最佳实践不一定是好事情。
预防徒劳无功，减少“在陆地上划船”这样的事情发生

一味地追求简洁。太较真是招人恨的，恨得牙痒痒；但是不较真，人云亦云得过且过，又做不出好东西。鱼和熊掌不可兼得。我安慰自己说，要
勇敢地直面别人困难，不退缩，把事情做好为首要原则。
为什么要追求简洁，因为简洁意味着：
1. 开发高效
1. 维护简单
1. 学习成本低
1. 更健壮，安全性高
绝对不是为了简洁而简洁，因为为了简洁而简洁，会犯舍本逐末的错误，导致本来2行代码非要写成一行，这样做反而使得难以理解，维护起来更加复杂。
所以我们简洁与简化具体包括：
1. 小：把复杂感念简单化，保留原子化概念，实际上就是把疙瘩的网线展开拉平的工作，剪去或者不必要的网线，把长网线改为短网线。
1. 小：公共逻辑抽取。如原来10根网线，现在换成一根网线，多路复用技术。
1. 小：抽象化，接口化：本质上是标准化，如USB Type-C标准，让世界规则更高效，减少多少不必要的内耗。
1. 美：去掉冗余：祛斑去痘工作，更帅气、更美丽
1. 美：最后才是代码逻辑行优化：最新的写法：时尚；发现好用的工具类：品味；衣着光鲜而时尚。

### 质疑
##### 1. 80%的情况下，用户都是全套使用，那么模块拆分得这么细有什么用呢，废这老大劲干啥？
我的回答：
这个问题本质是“实用主义”与“完美主义”两种编码态度的交锋。到底是实现功能交付钱到手就完了，还是追求代码简洁，这两种不同的态度姑且不论。
回归到模块拆分上来，有以下好处：
1. 各个模块目标专注，价值所在：比如：common的目标是不侵入用户业务逻辑的统一公司代码风格，提供代码规范。
1. 一团乱麻 vs 整整齐齐的区别（google数据中心布线图）。解铃还须系铃人，系铃人都解不开。小的东西自由组合为大的东西，这是模块化、微服务，组件化的核心思想，
1. 面向未来:diamond-log,diamond-security边界清晰，各自独立发展。
1. 80%是基于历史数据分析，甚至是感觉和猜测。要知道用户需求是需要培养的。只要产品目标清晰、本身具备真实价值
而不是想象出来的价值，那么就值得推广和试错，值得为这个目标去培养用户。今天是80%,那么明天呢？



缓存最重要的就是管理好缓存的生命周期，保证数据的一致性：
@EnableCache：开启基于注解的缓存。通常我们放在application的主方法中
@Cacheable：针对方法请求参数对结果进行缓存
@CachePut：保证方法的调用/执行，以及更新缓存
@CacheEvict：清除缓存



我的技术世界里，不参杂政治。
希望您晚上睡觉前抽空看一下，这个时间点儿看这个应该不会觉着膈应。
心里话：
每个人都有执念，我的执念就是把我喜欢的事情和自我觉着重要的事情，做好。
我打新心底里面就接受不了应付了事这种风格，除非做的事情实我觉着没必要做的。
小时候上学的学习习惯，包括长大后开始工作后的习惯，都是这个习惯，改不了，也不想改。

事情做好了我就很开心。即使具体过程中会触犯谁的利益。
事情做不好我就觉得很失落，即使我能从这件事情上获取很多利益。

凡事成于细。

当然，如果做好一件事，让很多人从中受益，那会让这件事更有意义。
所以，我很关注人，但是更关注事情本身。

希望您继续允许我和您争论技术。
我做的所有努力都是事情本身。只有想得越多方方面面都考虑到了，想全了才能更容易地做好事情。
何况做这件事情的初心是正的不是歪的,就是想把事情做好。对于，平时工作中的技术碰撞和争论，只有
开明的正能量的领导才允许下属没事就当着所有同事的面和领导争论。争论对做事情来说我觉得不是坏事，
反而是思维碰撞，产生领导，汇集集体智慧的一种方式。没有争论，一家独大，死气沉沉，我不觉得这是好的
氛围。我是打心底感激您气得不要不要的时候还能容忍我。另外，您丰富的项目经验，周密的思维，智慧地调和，
，还有很多我目前阶段无法理解和体会到的更多的能力和智慧，是我即使学10年也有可能也学不会的。

当在小达人项目上，我有力使不出，被迫加班，还要接受各级领导的批评指责。吃力不讨好，我真的是不能忍。
当韩总批评我一个人可以，但是批评我的同事、领导，我真的觉得脸上非常没面子。打篮球输了，被人虐了没事再来，
就怕被人虐了，自己还不知道被虐的原因，下次还被虐。Diamon的问题绝对不是领导对Diamon的目标的问题，也绝对不是
夏总您的问题。归根结底，不管您是否愿意承认，是各个执行者态度和能力问题导致的Diamon产品质量太次的问题。
基于Diamon开发新业务，没有提高效率，没有帮程序员什么忙；反而在降低效率，帮倒忙。我相信，您也不愿意为
别人犯下的错误来背锅，就算您不介意，不在乎是否背锅，但是我做为部门下属也绝对不愿意看到这个局面。
是的，下属犯错，就该领导来承担。但是对技术来说，难道领导每天还要花费精力来看命名大小写问题吗？
这些都是作为一个下属最基本的工作，领导还要每天盯着这些细节，那要下属何用？
虽然不是什么大事情，但是见微知著，以小见大的啊，千里之堤毁于蚁穴;当当网是从发货丢失一本书为表象开始衰落的。
起码做到以后不背锅，没有过错。工具好，意味着高效，不用加班，不费吹灰之力，偶尔还有小功劳，这样才是长久之计呀。
“一屋不扫，何以扫天下”，Diamon不重构，基于Diamon的很多工作就漏洞摆出，免不了以后还要背锅。

Diamon重构，你也看代码来，没有什么技术含量，无外乎就是抽象、定义规范的工作而已。我之所以费老大劲来
做这个的初心。

下属事情做不好，让领导来负责。一句话，希望您了解我的初心，只有您的认可，提供舞台，我才能把事情做好，而事情做好以后，所有人尤其是您
都会从中收益，起码不会再有不必要的批评和替别人背锅的事情发生。

变革的时代，技术不断迭代的时代。怎么更好地利用有限的时间，把事情做完，还做好，学问太大了，我hold不住，但是我
可以也愿意用加班来弥补。我一直在您面前说“高效”，高效意味着我不用加班了。

您是一个开明的伯乐，我也因此不愿意再折腾跳槽之类的。

高效是一种高级的偷懒方式，也是一种正能量的偷懒方式。给领导提供更多高效的技术，让领导少加班，
少费心，我觉得这是下属的职责。这也是我为什么没事就“高效高效”的。把好的东西介绍给领导，也是下属
的职责，这也就是为什么没事哪个新东西出来。

夏总，您周六和我说了很多话，感觉您也不断地旁敲侧击地提醒我。我也只是懵懵懂懂地明白个轮廓而已，无法全明白。
我2013年毕业，工作7年了，一事无成，其实我每天过得都很失落很迷茫。您曾经无意中问我老了以后
理想是什么，我说：我希望像李嘉诚那样，80多岁还有健康的身体，在工作岗位。有事情做。我不愿意像
现在的老头们一样百无聊赖地混日子。但是我现在的状态，我感觉自己就是在混吃等死的样子，我不喜欢自己这么
活着。
郭德纲说：要想成功，就不能太要面子；一碗泡面，软了能吃，硬着也能吃。
我也许就是太要面子了，我还没有学会怎么跪着把钱挣了，站起来当大爷。
我每天想的事情就是怎么高效和怎么赚钱，自我感觉要想成功就要多磨练。我真真的对办公室政治一点儿都不感兴趣。而且我这个级别
也没有资格搞这些虚头八脑的事情。在我眼里，办公室政治意味着内耗，都什么年代了还整天搞这些。
但是听了您的话，办公室政治不管我愿不愿意，也许就发生在我身边。但是，我不会抵触他，我会接受他；但是
我绝对不会做一个沉沦在职场政治里的小丑，我要做的是要学会一种更有智慧的方式来直面并且对抗这种
负能量。感恩和尽职尽责是基本的。正能量氛围里面，每个人都会感恩和尽责。但是一旦负能量充斥
着一个团体，各种奇形怪状的事情就会来到自己身边，拉扯着吸允着我的精力和鲜血，我只想说，咱们
都不是有钱人，不要再消耗我的精力好不好，让我把精力用到做事情上来。气儿顺了，脉通了，所有人都会显得
更加聪明和智慧，尤其是领导。气儿不顺，脉不通，虽然表面上身体还在运行，但实际上病入膏肓，所有人都要
难受，要受别人的气。




我每天想的事情是怎么赚钱，如果您有什么赚钱的机会，我不怕苦不怕累，更不抠门。








